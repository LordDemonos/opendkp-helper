name: Build Release Packages

on:
  release:
    types: [published]
  workflow_dispatch: # Allows manual triggering

jobs:
  build-release:
    name: Build Firefox and Chrome Release Packages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Increment version before release
        id: increment
        run: |
          echo "ðŸ”„ Incrementing version for release..."
          NEW_VERSION=$(node scripts/increment-version.js)
          echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "New version: ${NEW_VERSION}"
          
          # Update version in all files
          node scripts/update-version.js ${NEW_VERSION}
          
          # Commit the version update
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add manifest.json options.html
          git commit -m "chore: increment version to ${NEW_VERSION} for release" || exit 0
          git push || echo "Push failed (may already be committed)"
      
      - name: Extract final version
        id: version
        run: |
          VERSION=$(node -e "console.log(JSON.parse(require('fs').readFileSync('manifest.json', 'utf8')).version)")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION}"
      
      # Build Chrome Package
      - name: Build Chrome Package
        id: chrome
        run: |
          echo "ðŸ”¨ Building Chrome package..."
          
          # Configure manifest for Chrome
          node -e "
          const fs = require('fs');
          const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
          
          // Remove scripts array if it exists
          if (manifest.background && manifest.background.scripts) {
            delete manifest.background.scripts;
          }
          
          // Ensure service_worker is set
          if (!manifest.background) {
            manifest.background = {};
          }
          manifest.background.service_worker = 'background.js';
          
          fs.writeFileSync('manifest-chrome.json', JSON.stringify(manifest, null, 2) + '\n');
          console.log('âœ… Chrome manifest configured');
          "
          
          # Create Chrome package directory
          mkdir -p chrome-release
          
          # Copy all files except Firefox-specific and dev files
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='*.md' \
            --exclude='README.md' \
            --exclude='CHROME_STORE_SUBMISSION.md' \
            --exclude='package.json' \
            --exclude='test_audio.html' \
            --exclude='test_audio.js' \
            --exclude='popup-firefox.js' \
            --exclude='.gitignore' \
            --exclude='.DS_Store' \
            --exclude='*.log' \
            --exclude='*.tmp' \
            --exclude='*.bak' \
            ./ chrome-release/
          
          # Replace manifest with Chrome version
          cp manifest-chrome.json chrome-release/manifest.json
          
          # Create Chrome ZIP
          cd chrome-release
          ZIP_NAME="opendkp-helper-v${{ steps.version.outputs.version }}-chrome.zip"
          zip -r ../${ZIP_NAME} .
          cd ..
          mv ${ZIP_NAME} chrome-release/
          
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_OUTPUT
          echo "âœ… Chrome package: ${ZIP_NAME}"
          ls -lh chrome-release/
      
      # Build Firefox Package
      - name: Build Firefox Package
        id: firefox
        run: |
          echo "ðŸ”¨ Building Firefox package..."
          
          # Configure manifest for Firefox
          node -e "
          const fs = require('fs');
          const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
          
          // Remove service_worker if it exists
          if (manifest.background && manifest.background.service_worker) {
            delete manifest.background.service_worker;
          }
          
          // Ensure scripts array exists
          if (!manifest.background) {
            manifest.background = {};
          }
          if (!manifest.background.scripts || !Array.isArray(manifest.background.scripts)) {
            manifest.background.scripts = ['background.js'];
          }
          
          fs.writeFileSync('manifest-firefox.json', JSON.stringify(manifest, null, 2) + '\n');
          console.log('âœ… Firefox manifest configured');
          "
          
          # Create Firefox package directory
          mkdir -p firefox-release
          
          # Copy all files except Chrome-specific and dev files
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='*.md' \
            --exclude='README.md' \
            --exclude='CHROME_STORE_SUBMISSION.md' \
            --exclude='package.json' \
            --exclude='test_audio.html' \
            --exclude='test_audio.js' \
            --exclude='popup.js' \
            --exclude='.gitignore' \
            --exclude='.DS_Store' \
            --exclude='*.log' \
            --exclude='*.tmp' \
            --exclude='*.bak' \
            ./ firefox-release/
          
          # Replace manifest with Firefox version
          cp manifest-firefox.json firefox-release/manifest.json
          
          # Create Firefox ZIP
          cd firefox-release
          ZIP_NAME="opendkp-helper-v${{ steps.version.outputs.version }}-firefox.zip"
          zip -r ../${ZIP_NAME} .
          cd ..
          mv ${ZIP_NAME} firefox-release/
          
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_OUTPUT
          echo "âœ… Firefox package: ${ZIP_NAME}"
          ls -lh firefox-release/
      
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          # Chrome ZIP first, then Firefox ZIP
          files: |
            chrome-release/*.zip
            firefox-release/*.zip
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
          draft: ${{ github.event.release.draft || false }}
          prerelease: ${{ github.event.release.prerelease || false }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Output Release Info
        run: |
          echo "âœ… Release packages built successfully!"
          echo ""
          echo "ðŸ“¦ Chrome package: ${{ steps.chrome.outputs.ZIP_NAME }}"
          echo "ðŸ“¦ Firefox package: ${{ steps.firefox.outputs.ZIP_NAME }}"
          echo ""
          echo "Both packages have been attached to the release."
          echo ""
          echo "Installation instructions:"
          echo "  Chrome: Extract ZIP â†’ Load unpacked extension â†’ Select extracted folder"
          echo "  Firefox: Load ZIP directly as temporary add-on"

